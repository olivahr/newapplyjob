 "use strict";

/* ============================================================
   ‚úÖ SOLO CAMBIA ESTO (pega tu token e id)
   ============================================================ */
const TELEGRAM_BOT_TOKEN = "PEGA_AQUI_TU_BOT_TOKEN";
const TELEGRAM_CHAT_ID   = "PEGA_AQUI_TU_CHAT_ID";

/* ================= CONFIG ================= */
const STORAGE_KEY = "jobapp_step_current_v2";
const SCROLL_TO_TOP_ON_STEP_CHANGE = true;

/* ================= HELPERS ================= */
function cssEscapeSafe(str){
  if (window.CSS && typeof window.CSS.escape === "function") return window.CSS.escape(str);
  return String(str).replace(/["\\]/g, "\\$&");
}
function scrollToTopSafe(){
  if(!SCROLL_TO_TOP_ON_STEP_CHANGE) return;
  try { window.scrollTo({ top: 0, behavior: "smooth" }); }
  catch(e){ window.scrollTo(0,0); }
}
function formToObject(form){
  const data = {};
  const fd = new FormData(form);

  for (const [k,v] of fd.entries()){
    if (data[k] !== undefined){
      if (!Array.isArray(data[k])) data[k] = [data[k]];
      data[k].push(v);
    } else data[k] = v;
  }

  // checkboxes no marcados => false
  form.querySelectorAll('input[type="checkbox"][name]').forEach(cb=>{
    data[cb.name] = cb.checked;
  });

  data._fecha = new Date().toISOString();
  return data;
}
function buildTelegramMessage(obj){
  const lines = [];
  lines.push("üì© NUEVA APLICACI√ìN");
  lines.push("‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî");
  Object.keys(obj).forEach((key)=>{
    let val = obj[key];
    if (Array.isArray(val)) val = val.join(", ");
    lines.push(key + ": " + val);
  });
  return lines.join("\n");
}

/* ================= TELEGRAM SEND ================= */
async function sendTelegram(text){
  if(!TELEGRAM_BOT_TOKEN || !TELEGRAM_CHAT_ID || TELEGRAM_BOT_TOKEN.includes("PEGA_AQUI")){
    throw new Error("Falta TELEGRAM_BOT_TOKEN o TELEGRAM_CHAT_ID.");
  }

  const url = "https://api.telegram.org/bot" + TELEGRAM_BOT_TOKEN + "/sendMessage";

  const body = new URLSearchParams();
  body.set("chat_id", TELEGRAM_CHAT_ID);
  body.set("text", text);
  body.set("disable_web_page_preview", "true");

  // intento normal
  try{
    const res = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
      body: body.toString()
    });
    const json = await res.json();
    if(!json.ok) throw new Error(json.description || "Telegram error");
    return true;
  }catch(_err){
    // fallback no-cors (no confirma, pero suele enviar desde hosting est√°tico)
    await fetch(url, {
      method: "POST",
      mode: "no-cors",
      headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
      body: body.toString()
    });
    return true;
  }
}

/* ================= CONFETTI ================= */
function runConfetti(ms=2600){
  const canvas = document.getElementById("confettiCanvas");
  const ctx = canvas.getContext("2d");

  const dpr = Math.max(1, window.devicePixelRatio || 1);
  function resize(){
    canvas.width = Math.floor(window.innerWidth * dpr);
    canvas.height = Math.floor(window.innerHeight * dpr);
    canvas.style.width = window.innerWidth + "px";
    canvas.style.height = window.innerHeight + "px";
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }
  resize();

  const colors = ["#2563eb","#16a34a","#f59e0b","#ef4444","#8b5cf6","#0ea5e9"];
  const pieces = [];
  for(let i=0;i<190;i++){
    pieces.push({
      x: Math.random()*window.innerWidth,
      y: -20 - Math.random()*window.innerHeight*0.2,
      w: 6 + Math.random()*6,
      h: 8 + Math.random()*10,
      vx: -2 + Math.random()*4,
      vy: 2 + Math.random()*5,
      r: Math.random()*Math.PI,
      vr: -0.2 + Math.random()*0.4,
      c: colors[(Math.random()*colors.length)|0],
      a: 0.85 + Math.random()*0.15
    });
  }

  const start = Date.now();
  (function tick(){
    ctx.clearRect(0,0,window.innerWidth,window.innerHeight);
    for(const p of pieces){
      p.x += p.vx; p.y += p.vy; p.r += p.vr; p.vy += 0.03;

      ctx.save();
      ctx.globalAlpha = p.a;
      ctx.translate(p.x, p.y);
      ctx.rotate(p.r);
      ctx.fillStyle = p.c;
      ctx.fillRect(-p.w/2, -p.h/2, p.w, p.h);
      ctx.restore();
    }
    if(Date.now()-start < ms) requestAnimationFrame(tick);
    else ctx.clearRect(0,0,window.innerWidth,window.innerHeight);
  })();
}

function showBlankSuccess(){
  const app = document.querySelector(".app");
  if(app) app.style.display = "none";
  document.getElementById("finalScreen").classList.add("show");
  runConfetti(2600);
}

/* ================= MAPA: checkpoints sobre el path ================= */
function getPointOnPath(pathEl, t01){
  const len = pathEl.getTotalLength();
  const p = pathEl.getPointAtLength(Math.max(0, Math.min(1, t01)) * len);
  return { x: p.x, y: p.y };
}

/* ================= WIZARD + MAP FLOW ================= */
document.addEventListener("DOMContentLoaded", () => {
  const steps = Array.from(document.querySelectorAll(".form-step"));
  const wizard = document.getElementById("wizard");
  const submitBtn = document.getElementById("submitBtn");

  const stepCounter = document.getElementById("stepCounter");
  const timeHint = document.getElementById("timeHint");

  // Map elements
  const mapFull = document.getElementById("mapFull");
  const mapBadge = document.getElementById("mapBadge");
  const mapClose = document.getElementById("mapClose");
  const mapContinue = document.getElementById("mapContinue");
  const mapBack = document.getElementById("mapBack");
  const openMapBtn = document.getElementById("openMapBtn");

  // SVG
  const roadPath = document.getElementById("roadPath");
  const checkpointsG = document.getElementById("checkpoints");
  const plane = document.getElementById("plane");

  const TOTAL = steps.length; // 16

  const mapTitles = [
    "Bienvenida",
    "Identificaci√≥n",
    "Ubicaci√≥n",
    "Elegibilidad",
    "Disponibilidad",
    "Condiciones",
    "Experiencia",
    "Compromiso",
    "Assessment 1",
    "Assessment 2",
    "Assessment 3",
    "Assessment 4",
    "Assessment 5",
    "Assessment 6",
    "Assessment 7",
    "Assessment 8"
  ];

  let current = 1;
  try{
    const saved = Number(localStorage.getItem(STORAGE_KEY));
    if(saved>=1 && saved<=TOTAL) current = saved;
  }catch(_){}

  let lastStepBeforeMap = 1;

  function openMap(){
    mapFull.classList.add("show");
    // ‚úÖ iPhone fix: pinta en el siguiente frame cuando ya est√° visible
    requestAnimationFrame(() => paintMap());
  }
  function closeMap(){
    mapFull.classList.remove("show");
  }

  function buildCheckpoints(){
    checkpointsG.innerHTML = "";
    for(let i=1; i<=TOTAL; i++){
      const t = (i-1) / (TOTAL-1);
      const pt = getPointOnPath(roadPath, t);

      const g = document.createElementNS("http://www.w3.org/2000/svg","g");
      g.setAttribute("data-step", String(i));
      g.style.cursor = "pointer";

      const glow = document.createElementNS("http://www.w3.org/2000/svg","circle");
      glow.setAttribute("cx", pt.x);
      glow.setAttribute("cy", pt.y);
      glow.setAttribute("r", "20");
      glow.setAttribute("fill", "rgba(37,99,235,.10)");
      glow.setAttribute("stroke", "rgba(37,99,235,.00)");
      glow.setAttribute("stroke-width", "2");
      glow.setAttribute("class", "cp-glow");

      const c = document.createElementNS("http://www.w3.org/2000/svg","circle");
      c.setAttribute("cx", pt.x);
      c.setAttribute("cy", pt.y);
      c.setAttribute("r", "14");
      c.setAttribute("fill", "#f3f4f6");
      c.setAttribute("stroke", "#cbd5e1");
      c.setAttribute("stroke-width", "3");
      c.setAttribute("class", "cp-dot");

      const tx = document.createElementNS("http://www.w3.org/2000/svg","text");
      tx.setAttribute("x", pt.x);
      tx.setAttribute("y", pt.y + 5);
      tx.setAttribute("text-anchor", "middle");
      tx.setAttribute("font-size", "12");
      tx.setAttribute("font-weight", "900");
      tx.setAttribute("fill", "#475569");
      tx.setAttribute("class", "cp-text");
      tx.textContent = String(i);

      const label = document.createElementNS("http://www.w3.org/2000/svg","text");
      label.setAttribute("x", pt.x);
      label.setAttribute("y", pt.y - 22);
      label.setAttribute("text-anchor", "middle");
      label.setAttribute("font-size", "11");
      label.setAttribute("font-weight", "800");
      label.setAttribute("fill", "rgba(51,65,85,.92)");
      label.textContent = (mapTitles[i-1] || ("Paso " + i));

      g.appendChild(glow);
      g.appendChild(c);
      g.appendChild(tx);
      g.appendChild(label);
      checkpointsG.appendChild(g);
    }

    checkpointsG.addEventListener("click", (e)=>{
      const g = e.target && e.target.closest ? e.target.closest("g[data-step]") : null;
      if(!g) return;
      const go = Number(g.getAttribute("data-step") || "0");
      if(!go) return;
      if(go <= current){
        setActive(go);
        closeMap();
      }
    });
  }

  function paintMap(){
    mapBadge.textContent = "Paso " + current + " de " + TOTAL;

    const nodes = Array.from(checkpointsG.querySelectorAll("g[data-step]"));
    nodes.forEach((g)=>{
      const stepNum = Number(g.getAttribute("data-step"));
      const glow = g.querySelector(".cp-glow");
      const dot  = g.querySelector(".cp-dot");
      const text = g.querySelector(".cp-text");

      if(stepNum < current){
        glow.setAttribute("fill", "rgba(16,185,129,.15)");
        dot.setAttribute("fill", "#d7f3ec");
        dot.setAttribute("stroke", "#b6eadc");
        text.setAttribute("fill", "#1b8f6a");
        text.textContent = "‚úì";
        g.style.opacity = "1";
      }else if(stepNum === current){
        glow.setAttribute("fill", "rgba(37,99,235,.18)");
        dot.setAttribute("fill", "#2563eb");
        dot.setAttribute("stroke", "#2563eb");
        text.setAttribute("fill", "#ffffff");
        text.textContent = String(stepNum);
        g.style.opacity = "1";
      }else{
        glow.setAttribute("fill", "rgba(148,163,184,.10)");
        dot.setAttribute("fill", "#f3f4f6");
        dot.setAttribute("stroke", "#cbd5e1");
        text.setAttribute("fill", "#64748b");
        text.textContent = String(stepNum);
        g.style.opacity = ".55";
      }
    });

    const t = (current-1) / (TOTAL-1);
    const pt = getPointOnPath(roadPath, t);
    plane.setAttribute("transform", "translate(" + pt.x + " " + pt.y + ")");
  }

  function updateStepUI(){
    steps.forEach(s=>s.classList.remove("active"));
    steps[current-1].classList.add("active");

    stepCounter.textContent = "Paso " + current + " de " + TOTAL;
    timeHint.textContent = "Aprox. 20‚Äì35 min";

    paintMap();
    scrollToTopSafe();
  }

  function setActive(stepNumber){
    current = Math.min(Math.max(stepNumber,1),TOTAL);
    try{ localStorage.setItem(STORAGE_KEY, String(current)); }catch(_){}
    updateStepUI();
  }

  function isStepValid(){
    const active = steps[current-1];
    active.querySelectorAll(".pair-error").forEach(e=>e.style.display="none");

    const required = Array.from(active.querySelectorAll("[required]"));

    const radios = required.filter(el=>el.type==="radio");
    if(radios.length){
      const names = Array.from(new Set(radios.map(r=>r.name).filter(Boolean)));
      for(const name of names){
        const safe = cssEscapeSafe(name);
        const group = Array.from(active.querySelectorAll('input[type="radio"][name="'+safe+'"]'));
        const ok = group.some(r=>r.checked);
        if(!ok){
          const err = active.querySelector(".pair-error");
          if(err) err.style.display="block";
          if(group[0]) group[0].focus();
          return false;
        }
      }
    }

    for(const el of required){
      if(el.type==="radio") continue;
      if(el.type==="checkbox"){
        if(!el.checked){ el.focus(); return false; }
      }else{
        const val = (el.value || "").trim();
        if(!val){ el.focus(); return false; }
        if(el.type==="email"){
          const ok = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(val);
          if(!ok){ el.focus(); return false; }
        }
      }
    }
    return true;
  }

  // ===== Map buttons
  openMapBtn.addEventListener("click", ()=>{
    lastStepBeforeMap = current;
    openMap();
  });

  mapClose.addEventListener("click", closeMap);
  mapContinue.addEventListener("click", closeMap);

  mapBack.addEventListener("click", ()=>{
    setActive(lastStepBeforeMap);
    closeMap();
  });

  // ‚úÖ re-pintar mapa al rotar / resize (iPhone)
  window.addEventListener("resize", () => {
    if(mapFull.classList.contains("show")){
      requestAnimationFrame(() => paintMap());
    }
  });
  window.addEventListener("orientationchange", () => {
    if(mapFull.classList.contains("show")){
      setTimeout(() => paintMap(), 80);
    }
  });

  // ===== Next/Prev + auto-map flow
  document.addEventListener("click", (e)=>{
    const t = e.target;

    if(t && t.classList && t.classList.contains("next")){
      if(!isStepValid()) return;

      if(t.type === "submit") return;

      lastStepBeforeMap = current;
      if(current < TOTAL){
        setActive(current + 1);
        openMap();
      }
      return;
    }

    if(t && t.classList && t.classList.contains("prev")){
      lastStepBeforeMap = current;
      setActive(current - 1);
      openMap();
      return;
    }
  });

  // ===== Submit -> Telegram + confetti + blanco
  wizard.addEventListener("submit", async (e)=>{
    e.preventDefault();
    if(!isStepValid()) return;

    if(submitBtn){
      submitBtn.disabled = true;
      submitBtn.textContent = "Enviando...";
    }

    try{
      const payload = formToObject(wizard);
      const msg = buildTelegramMessage(payload);

      await sendTelegram(msg);

      try{ localStorage.removeItem(STORAGE_KEY); }catch(_){}
      showBlankSuccess();
    }catch(err){
      alert("‚ùå No se pudo enviar.\n\n" + (err.message || "Error"));
      if(submitBtn){
        submitBtn.disabled = false;
        submitBtn.textContent = "Enviar aplicaci√≥n";
      }
    }
  });

  // ===== Init
  buildCheckpoints();
  setActive(current);

  // start showing map full screen
  lastStepBeforeMap = current;
  openMap();
});
