<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Application SunPower</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#f3f4f6;
  --card:#ffffff;
  --text:#0f172a;
  --muted:#475569;
  --line:#e5e7eb;
  --blue:#2563eb;
  --blue2:#1d4ed8;
  --mint:#d7f3ec;
  --mintB:#b6eadc;
  --radius:18px;
}
html{-webkit-text-size-adjust:100%;text-size-adjust:100%;}
*{box-sizing:border-box;font-family:Inter,sans-serif}
body{margin:0;background:var(--bg);color:var(--text)}
a{color:var(--blue);text-decoration:none}
strong{font-weight:700}

/* Layout */
.app{
  max-width:1120px;
  margin:26px auto;
  background:var(--card);
  border-radius:var(--radius);
  box-shadow:0 20px 60px rgba(0,0,0,.12);
  padding:28px;
  display:grid;
  grid-template-columns: 280px 1fr;
  gap:28px;
}

/* Header */
.top{
  grid-column: 1 / -1;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:16px;
  padding-bottom:10px;
  border-bottom:1px solid var(--line);
  margin-bottom:6px;
}
.brand{font-weight:800;letter-spacing:.2px}
.step-pill{
  font-size:13px;
  color:var(--muted);
  background:#f8fafc;
  border:1px solid var(--line);
  padding:8px 12px;
  border-radius:999px;
  display:flex;
  gap:10px;
  align-items:center;
  white-space:nowrap;
}

/* Progress bar */
.progress-wrap{
  grid-column: 1 / -1;
  margin-top:6px;
  margin-bottom:6px;
}
.progress-bar{
  height:10px;
  background:#eef2ff;
  border:1px solid var(--line);
  border-radius:999px;
  overflow:hidden;
}
.progress{
  height:100%;
  width:0%;
  background:linear-gradient(90deg, var(--blue), #4f46e5);
  transition:width .25s ease;
}

/* Map */
.map{
  position:sticky;
  top:18px;
  align-self:start;
  padding:8px 6px;
}
.map-title{
  font-size:13px;
  color:var(--muted);
  font-weight:700;
  letter-spacing:.2px;
  margin:0 0 10px;
  text-transform:uppercase;
}
.timeline{
  position:relative;
  padding-left:18px;
}
.timeline::before{
  content:"";
  position:absolute;
  left:8px;
  top:6px;
  bottom:6px;
  width:2px;
  background:linear-gradient(180deg, #cbd5e1, #e2e8f0);
  border-radius:999px;
}
.mstep{
  position:relative;
  display:flex;
  align-items:center;
  gap:10px;
  padding:10px 8px;
  border-radius:12px;
  cursor:pointer;
  user-select:none;
}
.mstep:hover{background:#f8fafc}
.dot{
  width:28px;height:28px;
  border-radius:10px;
  display:flex;align-items:center;justify-content:center;
  font-weight:800;
  border:1px solid #d1d5db;
  background:#f3f4f6;
  color:#64748b;
  flex:0 0 auto;
}
.mtext{display:flex;flex-direction:column;gap:2px}
.mtext .t1{font-weight:700;font-size:13px}
.mtext .t2{font-size:12px;color:var(--muted)}
.mstep.active{
  background:#eef2ff;
  outline:2px solid rgba(37,99,235,.18);
}
.mstep.active .dot{
  background:var(--blue);
  border-color:transparent;
  color:#fff;
}
.mstep.done .dot{
  background:var(--mint);
  border:2px solid var(--mintB);
  color:#1b8f6a;
}
.mstep.locked{opacity:.55;cursor:not-allowed}

/* Form */
.panel{padding:6px 6px 10px}
h2{font-size:22px;margin:0 0 14px}
p{font-size:14px;color:#334155;line-height:1.8;margin:0 0 12px}
.form-step{display:none}
.form-step.active{display:block}

/* Inputs */
label{
  display:block;
  margin-top:18px;
  font-size:14px;
  font-weight:800;
  color:#0f172a;
}
input,select,textarea{
  width:100%;
  padding:14px;
  margin-top:6px;
  border:1px solid #d1d5db;
  border-radius:12px;
  font-size:16px; /* iPhone no zoom */
  outline:none;
  background:#fff;
}
input:focus,select:focus,textarea:focus{
  border-color:#60a5fa;
  box-shadow:0 0 0 4px rgba(59,130,246,.15);
}
textarea{min-height:110px;resize:vertical}

/* Checkbox rows */
.check{
  display:flex;
  gap:10px;
  margin-top:14px;
  font-size:14px;
  color:#0f172a;
  align-items:flex-start;
}
.check input{width:18px;height:18px;margin-top:2px}

/* Buttons */
.buttons{
  display:flex;
  justify-content:space-between;
  gap:12px;
  margin-top:26px;
  padding-top:12px;
  border-top:1px solid var(--line);
}
button{
  padding:14px 22px;
  border:none;
  border-radius:999px;
  font-size:14px;
  font-weight:900;
  cursor:pointer;
}
.prev{background:#e5e7eb;color:#111827}
.next{background:var(--blue);color:#fff}
.next:hover{background:var(--blue2)}
button:disabled{opacity:.45;pointer-events:none}

/* Assessment 9-18 */
.form-step[data-step="9"] label,
.form-step[data-step="10"] label,
.form-step[data-step="11"] label,
.form-step[data-step="12"] label,
.form-step[data-step="13"] label,
.form-step[data-step="14"] label,
.form-step[data-step="15"] label,
.form-step[data-step="16"] label,
.form-step[data-step="17"] label,
.form-step[data-step="18"] label{
  margin-top:10px;
  font-weight:800;
  display:flex;
  align-items:center;
  gap:10px;
  padding:12px 12px;
  border:1px solid var(--line);
  border-radius:12px;
  background:#fff;
  cursor:pointer;
}
.form-step[data-step="9"] label input,
.form-step[data-step="10"] label input,
.form-step[data-step="11"] label input,
.form-step[data-step="12"] label input,
.form-step[data-step="13"] label input,
.form-step[data-step="14"] label input,
.form-step[data-step="15"] label input,
.form-step[data-step="16"] label input,
.form-step[data-step="17"] label input,
.form-step[data-step="18"] label input{
  width:18px;height:18px;margin:0;
}
.pair-error{
  background:#fef2f2;
  border:1px solid #fecaca;
  padding:10px 12px;
  border-radius:12px;
}

/* Mobile fix */
@media (max-width: 920px){
  .app{
    grid-template-columns:1fr;
    margin:0;
    border-radius:0;
    padding:16px;
    gap:14px;
  }
  .map{
    position:relative;
    top:auto;
    padding:10px;
    border:1px solid var(--line);
    border-radius:14px;
    background:#fff;
    max-height:180px;
    overflow:auto;
    -webkit-overflow-scrolling:touch;
  }
  .timeline{padding-left:0}
  .timeline::before{display:none}
  .panel{padding:0}
}

/* Final white + confetti */
.final-screen{
  position:fixed;
  inset:0;
  background:#fff;
  display:none;
  align-items:center;
  justify-content:center;
  z-index:99998;
  padding:18px;
}
.final-screen.show{display:flex;}
.final-card{
  width:min(560px,100%);
  border:1px solid #e5e7eb;
  border-radius:16px;
  padding:18px;
  box-shadow:0 20px 60px rgba(0,0,0,.14);
  text-align:center;
}
.final-card h3{
  margin:6px 0 6px;
  font-size:18px;
  font-weight:900;
  color:#0f172a;
}
.final-card p{
  margin:0;
  color:#334155;
  font-size:14px;
  line-height:1.5;
}
#confettiCanvas{
  position:fixed;
  inset:0;
  pointer-events:none;
  z-index:99999;
}
</style>
</head>

<body>
<div class="app">

  <div class="top">
    <div class="brand">Application SunPower</div>
    <div class="step-pill">
      <span id="stepCounter">Step 1 of 18</span>
      <span>‚Ä¢</span>
      <span id="timeHint">Approx. 20‚Äì35 min</span>
    </div>
  </div>

  <div class="progress-wrap">
    <div class="progress-bar"><div class="progress" id="progress"></div></div>
  </div>

  <aside class="map" aria-label="Progress map">
    <div class="map-title">Progress</div>
    <div class="timeline" id="timeline"></div>
  </aside>

  <main class="panel">
    <form id="wizard" novalidate>

      <!-- STEP 1 -->
      <section class="form-step active" data-step="1">
        <h2>Step 1 ‚Äî Welcome to the application</h2>
        <p>
          Thank you for your interest in participating in large-scale corporate operations.
          This application corresponds to an <strong>initial assessment</strong>, used to determine
          basic compatibility with operational and support roles.
        </p>
        <p>
          The process is designed to be clear, structured, and transparent.
          No specific experience is required to complete this stage.
        </p>
        <p>
          Estimated application time: <strong>20 to 35 minutes</strong>.
          We recommend completing it in a single session.
        </p>
        <div class="buttons">
          <span></span>
          <button type="button" class="next">Continue</button>
        </div>
      </section>

      <!-- STEP 2 -->
      <section class="form-step" data-step="2">
        <h2>Step 2 ‚Äî Personal identification</h2>
        <p>The information entered in this section must match official documents.</p>
        <p>Make sure to correctly enter your full legal name and an active email address.</p>

        <label>Legal first name (as shown on documents)</label>
        <input required name="nombre">

        <label>Legal last name</label>
        <input required name="apellido">

        <label>Contact email address</label>
        <input type="email" required name="email">

        <label>Primary phone number</label>
        <input required name="telefono">

        <label>Do you have regular access to this email and phone?</label>
        <select required name="acceso">
          <option value="">Select</option>
          <option>Yes, both</option>
          <option>Email only</option>
          <option>Phone only</option>
          <option>Limited access</option>
        </select>

        <div class="buttons">
          <button type="button" class="prev">Previous</button>
          <button type="button" class="next">Continue</button>
        </div>
      </section>

      <!-- STEP 3 -->
      <section class="form-step" data-step="3">
        <h2>Step 3 ‚Äî Location and mobility</h2>
        <p>This section allows us to assess geographic availability and potential future assignments.</p>
       
        <label>Address</label>
        <input required name="ciudad">

        <label>Current city of residence</label>
        <input required name="ciudad">

        <label>State</label>
        <input required name="estado">

        <label>Postal code</label>
        <input required name="zip">

        <label>Is this the address of your ID?</label>
        <select required name="movilidad">
          <option value="">Select</option>
          <option>Yes</option>
          <option>No</option>
        </select>

        <label>How long have you been living at this address?</label>
        <select required name="mudanza">
          <option value="">Select</option>
          <option>1-3 years</option>
          <option>3-6 years</option>
          <option>10+ years</option>
        </select>

        <div class="buttons">
          <button type="button" class="prev">Previous</button>
          <button type="button" class="next">Continue</button>
        </div>
      </section>

      <!-- STEP 4 -->
      <section class="form-step" data-step="4">
        <h2>Step 4 ‚Äî Legal eligibility</h2>
        <p>These questions are mandatory to continue.</p>

        <div class="check"><input type="checkbox" required name="mayor18"><span>I am 18 years old or older</span></div>
        <div class="check"><input type="checkbox" required name="autorizado"><span>I am legally authorized to work</span></div>
        <div class="check"><input type="checkbox" required name="documentos"><span>I can provide valid documentation if requested</span></div>
        <div class="check"><input type="checkbox" required name="verificacion"><span>I understand that this information may be verified</span></div>

        <div class="buttons">
          <button type="button" class="prev">Previous</button>
          <button type="button" class="next">Continue</button>
        </div>
      </section>

      <!-- STEP 5 -->
      <section class="form-step" data-step="5">
        <h2>Step 5 ‚Äî General availability</h2>

        <label>Type of availability</label>
        <select required name="disponibilidad">
          <option value="">Select</option>
          <option>Full time</option>
          <option>Variable shifts</option>
          <option>Flexible availability</option>
          <option>Limited availability</option>
        </select>

        <label>Estimated start date</label>
        <input type="date" required name="fecha_inicio">

        <label>Do you currently have schedule restrictions?</label>
        <select required name="restricciones">
          <option value="">Select</option>
          <option>I have no restrictions</option>
          <option>Partial restrictions</option>
          <option>Significant restrictions</option>
        </select>

        <div class="buttons">
          <button type="button" class="prev">Previous</button>
          <button type="button" class="next">Continue</button>
        </div>
      </section>

      <!-- STEP 6 -->
      <section class="form-step" data-step="6">
        <h2>Step 6 ‚Äî Physical and operational conditions</h2>

        <div class="check"><input type="checkbox" required name="depie"><span>I can remain standing for extended shifts</span></div>
        <div class="check"><input type="checkbox" required name="fisico"><span>I can perform moderate physical tasks</span></div>
        <div class="check"><input type="checkbox" required name="limitaciones"><span>I have no limitations that prevent basic operational work</span></div>
        <div class="check"><input type="checkbox" required name="comunicar"><span>I can communicate any limitations if necessary</span></div>

        <div class="buttons">
          <button type="button" class="prev">Previous</button>
          <button type="button" class="next">Continue</button>
        </div>
      </section>

      <!-- STEP 7 -->
      <section class="form-step" data-step="7">
        <h2>Step 7 ‚Äî Work environment experience</h2>

        <label>Have you previously worked in operational or structured environments?</label>
        <select required name="entornos">
          <option value="">Select</option>
          <option>Yes</option>
          <option>No</option>
        </select>

        <label>How would you describe your adaptation to new environments?</label>
        <textarea required name="adaptacion" placeholder="Briefly describe your experience or approach"></textarea>

        <label>Do you feel comfortable following established procedures?</label>
        <select required name="procedimientos">
          <option value="">Select</option>
          <option>Yes</option>
          <option>No</option>
          <option>Depends on the situation</option>
        </select>

        <div class="buttons">
          <button type="button" class="prev">Previous</button>
          <button type="button" class="next">Continue</button>
        </div>
      </section>

      <!-- STEP 8 -->
      <section class="form-step" data-step="8">
        <h2>Step 8 ‚Äî Commitment and responsibility</h2>

        <div class="check"><input type="checkbox" required name="horarios"><span>I can comply with assigned schedules</span></div>
        <div class="check"><input type="checkbox" required name="instrucciones"><span>I can follow written and verbal instructions</span></div>
        <div class="check"><input type="checkbox" required name="variacion"><span>I understand that tasks may vary as needed</span></div>
        <div class="check"><input type="checkbox" required name="comunicar_dudas"><span>I can communicate problems or questions in a timely manner</span></div>

        <div class="buttons">
          <button type="button" class="prev">Previous</button>
          <button type="button" class="next">Continue</button>
        </div>
      </section>

      <!-- STEP 9 -->
<section class="form-step" data-step="9">
  <p><strong>Working quickly is more important than working safely.</strong></p>
  <label><input type="radio" name="assess_9" value="top_most" required> Most like me</label>
  <label><input type="radio" name="assess_9" value="top_more" required> More like me</label>
  <p style="text-align:center;font-weight:800;margin:10px 0;">&lt; or &gt;</p>
  <label><input type="radio" name="assess_9" value="bottom_more" required> More like me</label>
  <label><input type="radio" name="assess_9" value="bottom_most" required> Most like me</label>
  <p><strong>I need to be reminded of deadlines.</strong></p>

  <p class="pair-error" style="display:none;color:#b91c1c;font-weight:800;margin-top:10px;">
    Select an option to continue.
  </p>
  <div class="buttons">
    <button type="button" class="prev">Previous</button>
    <button type="button" class="next">Continue</button>
  </div>
</section>

<!-- STEP 10 -->
<section class="form-step" data-step="10">
  <p><strong>I usually reveal my mistakes to others when I notice them.</strong></p>
  <label><input type="radio" name="assess_10" value="top_most" required> Most like me</label>
  <label><input type="radio" name="assess_10" value="top_more" required> More like me</label>
  <p style="text-align:center;font-weight:800;margin:10px 0;">&lt; or &gt;</p>
  <label><input type="radio" name="assess_10" value="bottom_more" required> More like me</label>
  <label><input type="radio" name="assess_10" value="bottom_most" required> Most like me</label>
  <p><strong>Career growth is important to me.</strong></p>

  <p class="pair-error" style="display:none;color:#b91c1c;font-weight:800;margin-top:10px;">
    Select an option to continue.
  </p>
  <div class="buttons">
    <button type="button" class="prev">Previous</button>
    <button type="button" class="next">Continue</button>
  </div>
</section>

<!-- STEP 11 -->
<section class="form-step" data-step="11">
  <p><strong>People should always be working toward the next step in their career.</strong></p>
  <label><input type="radio" name="assess_11" value="top_most" required> Most like me</label>
  <label><input type="radio" name="assess_11" value="top_more" required> More like me</label>
  <p style="text-align:center;font-weight:800;margin:10px 0;">&lt; or &gt;</p>
  <label><input type="radio" name="assess_11" value="bottom_more" required> More like me</label>
  <label><input type="radio" name="assess_11" value="bottom_most" required> Most like me</label>
  <p><strong>Sometimes I think about how others have contributed to my success.</strong></p>

  <p class="pair-error" style="display:none;color:#b91c1c;font-weight:800;margin-top:10px;">
    Select an option to continue.
  </p>
  <div class="buttons">
    <button type="button" class="prev">Previous</button>
    <button type="button" class="next">Continue</button>
  </div>
</section>

<!-- STEP 12 -->
<section class="form-step" data-step="12">
  <p><strong>How right or wrong something is depends on the situation.</strong></p>
  <label><input type="radio" name="assess_12" value="top_most" required> Most like me</label>
  <label><input type="radio" name="assess_12" value="top_more" required> More like me</label>
  <p style="text-align:center;font-weight:800;margin:10px 0;">&lt; or &gt;</p>
  <label><input type="radio" name="assess_12" value="bottom_more" required> More like me</label>
  <label><input type="radio" name="assess_12" value="bottom_most" required> Most like me</label>
  <p><strong>I am not willing to compromise on principles.</strong></p>

  <p class="pair-error" style="display:none;color:#b91c1c;font-weight:800;margin-top:10px;">
    Select an option to continue.
  </p>
  <div class="buttons">
    <button type="button" class="prev">Previous</button>
    <button type="button" class="next">Continue</button>
  </div>
</section>

<!-- STEP 13 -->
<section class="form-step" data-step="13">
  <p><strong>Some safety rules are useless.</strong></p>
  <label><input type="radio" name="assess_13" value="top_most" required> Most like me</label>
  <label><input type="radio" name="assess_13" value="top_more" required> More like me</label>
  <p style="text-align:center;font-weight:800;margin:10px 0;">&lt; or &gt;</p>
  <label><input type="radio" name="assess_13" value="bottom_more" required> More like me</label>
  <label><input type="radio" name="assess_13" value="bottom_most" required> Most like me</label>
  <p><strong>Sometimes I work hard, and sometimes I hardly work.</strong></p>

  <p class="pair-error" style="display:none;color:#b91c1c;font-weight:800;margin-top:10px;">
    Select an option to continue.
  </p>
  <div class="buttons">
    <button type="button" class="prev">Previous</button>
    <button type="button" class="next">Continue</button>
  </div>
</section>

<!-- STEP 14 -->
<section class="form-step" data-step="14">
  <p><strong>I persist until a task is done.</strong></p>
  <label><input type="radio" name="assess_14" value="top_most" required> Most like me</label>
  <label><input type="radio" name="assess_14" value="top_more" required> More like me</label>
  <p style="text-align:center;font-weight:800;margin:10px 0;">&lt; or &gt;</p>
  <label><input type="radio" name="assess_14" value="bottom_more" required> More like me</label>
  <label><input type="radio" name="assess_14" value="bottom_most" required> Most like me</label>
  <p><strong>People can depend on me to tell the truth.</strong></p>

  <p class="pair-error" style="display:none;color:#b91c1c;font-weight:800;margin-top:10px;">
    Select an option to continue.
  </p>
  <div class="buttons">
    <button type="button" class="prev">Previous</button>
    <button type="button" class="next">Continue</button>
  </div>
</section>

<!-- STEP 15 -->
<section class="form-step" data-step="15">
  <p><strong>I strive to get ahead but also enjoy where I'm at.</strong></p>
  <label><input type="radio" name="assess_15" value="top_most" required> Most like me</label>
  <label><input type="radio" name="assess_15" value="top_more" required> More like me</label>
  <p style="text-align:center;font-weight:800;margin:10px 0;">&lt; or &gt;</p>
  <label><input type="radio" name="assess_15" value="bottom_more" required> More like me</label>
  <label><input type="radio" name="assess_15" value="bottom_most" required> Most like me</label>
  <p><strong>It's not always important to be promoted.</strong></p>

  <p class="pair-error" style="display:none;color:#b91c1c;font-weight:800;margin-top:10px;">
    Select an option to continue.
  </p>
  <div class="buttons">
    <button type="button" class="prev">Previous</button>
    <button type="button" class="next">Continue</button>
  </div>
</section>

<!-- STEP 16 -->
<section class="form-step" data-step="16">
  <p><strong>I follow instructions exactly the first time.</strong></p>
  <label><input type="radio" name="assess_16" value="top_most" required> Most like me</label>
  <label><input type="radio" name="assess_16" value="top_more" required> More like me</label>
  <p style="text-align:center;font-weight:800;margin:10px 0;">&lt; or &gt;</p>
  <label><input type="radio" name="assess_16" value="bottom_more" required> More like me</label>
  <label><input type="radio" name="assess_16" value="bottom_most" required> Most like me</label>
  <p><strong>I prefer to do things my own way, even if rules exist.</strong></p>

  <p class="pair-error" style="display:none;color:#b91c1c;font-weight:800;margin-top:10px;">
    Select an option to continue.
  </p>
  <div class="buttons">
    <button type="button" class="prev">Previous</button>
    <button type="button" class="next">Continue</button>
  </div>
</section>

<!-- STEP 17 -->
<section class="form-step" data-step="17">
  <p><strong>I stay calm and focused when things get hectic.</strong></p>
  <label><input type="radio" name="assess_17" value="top_most" required> Most like me</label>
  <label><input type="radio" name="assess_17" value="top_more" required> More like me</label>
  <p style="text-align:center;font-weight:800;margin:10px 0;">&lt; or &gt;</p>
  <label><input type="radio" name="assess_17" value="bottom_more" required> More like me</label>
  <label><input type="radio" name="assess_17" value="bottom_most" required> Most like me</label>
  <p><strong>I get stressed easily when there is pressure.</strong></p>

  <p class="pair-error" style="display:none;color:#b91c1c;font-weight:800;margin-top:10px;">
    Select an option to continue.
  </p>
  <div class="buttons">
    <button type="button" class="prev">Previous</button>
    <button type="button" class="next">Continue</button>
  </div>
</section>

<!-- STEP 18 -->
<section class="form-step" data-step="18">
  <p><strong>I double-check my work to avoid mistakes.</strong></p>
  <label><input type="radio" name="assess_18" value="top_most" required> Most like me</label>
  <label><input type="radio" name="assess_18" value="top_more" required> More like me</label>
  <p style="text-align:center;font-weight:800;margin:10px 0;">&lt; or &gt;</p>
  <label><input type="radio" name="assess_18" value="bottom_more" required> More like me</label>
  <label><input type="radio" name="assess_18" value="bottom_most" required> Most like me</label>
  <p><strong>I rarely review details once I finish a task.</strong></p>

  <p class="pair-error" style="display:none;color:#b91c1c;font-weight:800;margin-top:10px;">
    Select an option to continue.
  </p>
  <div class="buttons">
    <button type="button" class="prev">Previous</button>
    <button type="submit" class="next" id="submitBtn">Submit application</button>
  </div>
</section>

</form>
</main>
</div>

<!-- CONFETTI CANVAS + WHITE OVERLAY -->
<canvas id="confettiCanvas"></canvas>
<div class="final-screen" id="finalScreen" aria-live="polite">
  <div class="final-card">
    <h3>üéâ Congratulations</h3>
    <p>Your application has been successfully submitted. You may now close this page.</p>
  </div>
</div>

<script>
"use strict";

/* ============================================================
   ‚úÖ ONLY CHANGE THIS:
   ============================================================ */
const TELEGRAM_BOT_TOKEN = "8219963792:AAGWcvtcyC0rd0zMLXN2Uf3uPUySB9GuBTw";
const TELEGRAM_CHAT_ID   = "8547093828";

/* ================= CONFIG ================= */
const STORAGE_KEY = "jobapp_step_current_v1";
const SCROLL_TO_TOP_ON_STEP_CHANGE = true;

/* ================= HELPERS (Safari safe) ================= */
function cssEscapeSafe(str){
  if (window.CSS && typeof window.CSS.escape === "function") return window.CSS.escape(str);
  return String(str).replace(/["\\]/g, "\\$&");
}
function scrollToTopSafe(){
  if(!SCROLL_TO_TOP_ON_STEP_CHANGE) return;
  try { window.scrollTo({ top: 0, behavior: "smooth" }); }
  catch(e){ window.scrollTo(0,0); }
}
function formToObject(form){
  const data = {};
  const fd = new FormData(form);

  for (const [k,v] of fd.entries()){
    if (data[k] !== undefined){
      if (!Array.isArray(data[k])) data[k] = [data[k]];
      data[k].push(v);
    } else data[k] = v;
  }

  // unchecked checkboxes => false
  form.querySelectorAll('input[type="checkbox"][name]').forEach(cb=>{
    data[cb.name] = cb.checked;
  });

  // meta
  data._date = new Date().toISOString();

  return data;
}
function buildTelegramMessage(obj){
  const lines = [];
  lines.push("üì© NEW APPLICATION");
  lines.push("‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî");
  Object.keys(obj).forEach((key)=>{
    let val = obj[key];
    if (Array.isArray(val)) val = val.join(", ");
    lines.push(key + ": " + val);
  });
  return lines.join("\n");
}

/* ================= TELEGRAM SEND (CORS-safe) ================= */
async function sendTelegram(text){
  const url = "https://api.telegram.org/bot" + TELEGRAM_BOT_TOKEN + "/sendMessage";

  const body = new URLSearchParams();
  body.set("chat_id", TELEGRAM_CHAT_ID);
  body.set("text", text);
  body.set("disable_web_page_preview", "true");

  try{
    const res = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
      body: body.toString()
    });
    const json = await res.json();
    if(!json.ok) throw new Error(json.description || "Telegram error");
    return true;
  }catch(err){
    try{
      await fetch(url, {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
        body: body.toString()
      });
      return true;
    }catch(_){
      throw new Error("Unable to contact Telegram (blocked by network or browser).");
    }
  }
}

/* ================= CONFETTI ================= */
function runConfetti(ms=2600){
  const canvas = document.getElementById("confettiCanvas");
  const ctx = canvas.getContext("2d");

  const dpr = Math.max(1, window.devicePixelRatio || 1);
  function resize(){
    canvas.width = Math.floor(window.innerWidth * dpr);
    canvas.height = Math.floor(window.innerHeight * dpr);
    canvas.style.width = window.innerWidth + "px";
    canvas.style.height = window.innerHeight + "px";
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }
  resize();

  const colors = ["#2563eb","#16a34a","#f59e0b","#ef4444","#8b5cf6","#0ea5e9"];
  const pieces = [];
  for(let i=0;i<180;i++){
    pieces.push({
      x: Math.random()*window.innerWidth,
      y: -20 - Math.random()*window.innerHeight*0.2,
      w: 6 + Math.random()*6,
      h: 8 + Math.random()*10,
      vx: -2 + Math.random()*4,
      vy: 2 + Math.random()*5,
      r: Math.random()*Math.PI,
      vr: -0.2 + Math.random()*0.4,
      c: colors[(Math.random()*colors.length)|0],
      a: 0.85 + Math.random()*0.15
    });
  }

  const start = Date.now();
  (function tick(){
    ctx.clearRect(0,0,window.innerWidth,window.innerHeight);
    for(const p of pieces){
      p.x += p.vx; p.y += p.vy; p.r += p.vr; p.vy += 0.03;

      ctx.save();
      ctx.globalAlpha = p.a;
      ctx.translate(p.x, p.y);
      ctx.rotate(p.r);
      ctx.fillStyle = p.c;
      ctx.fillRect(-p.w/2, -p.h/2, p.w, p.h);
      ctx.restore();
    }
    if(Date.now()-start < ms) requestAnimationFrame(tick);
    else ctx.clearRect(0,0,window.innerWidth,window.innerHeight);
  })();
}
function showBlankSuccess(){
  const app = document.querySelector(".app");
  if(app) app.style.display = "none";
  document.getElementById("finalScreen").classList.add("show");
  runConfetti(2600);
}

/* ================= WIZARD ================= */
document.addEventListener("DOMContentLoaded", () => {
  const steps = Array.from(document.querySelectorAll(".form-step"));
  const progress = document.getElementById("progress");
  const stepCounter = document.getElementById("stepCounter");
  const timeline = document.getElementById("timeline");
  const wizard = document.getElementById("wizard");
  const submitBtn = document.getElementById("submitBtn");

  const TOTAL = steps.length;

  const mapTitles = [
    "Welcome","Identification","Location","Eligibility","Availability",
    "Conditions","Experience","Commitment",
    "Assessment 1","Assessment 2","Assessment 3","Assessment 4","Assessment 5",
    "Assessment 6","Assessment 7","Assessment 8","Assessment 9","Assessment 10"
  ];

  timeline.innerHTML = "";
  for(let i=1;i<=TOTAL;i++){
    const item=document.createElement("div");
    item.className="mstep locked";
    item.dataset.go=String(i);

    const dot=document.createElement("div");
    dot.className="dot";
    dot.textContent=String(i);

    const text=document.createElement("div");
    text.className="mtext";
    text.innerHTML =
      '<div class="t1">Step '+i+'</div>'+
      '<div class="t2">'+(mapTitles[i-1]||"")+'</div>';

    item.appendChild(dot);
    item.appendChild(text);
    timeline.appendChild(item);
  }
  const mapItems = Array.from(document.querySelectorAll(".mstep"));

  let current = 1;
  try{
    const saved = Number(localStorage.getItem(STORAGE_KEY));
    if(saved>=1 && saved<=TOTAL) current=saved;
  }catch(_){}

  function setActive(stepNumber){
    current = Math.min(Math.max(stepNumber,1),TOTAL);
    try{ localStorage.setItem(STORAGE_KEY,String(current)); }catch(_){}
    update();
  }

  function update(){
    steps.forEach(s=>s.classList.remove("active"));
    steps[current-1].classList.add("active");

    const pct=((current-1)/(TOTAL-1))*100;
    progress.style.width=pct+"%";
    stepCounter.textContent="Step "+current+" of "+TOTAL;

    mapItems.forEach((item,idx)=>{
      const stepNum=idx+1;
      item.classList.remove("done","active","locked");

      const dot=item.querySelector(".dot");
      if(stepNum<current){ item.classList.add("done"); dot.textContent="‚úì"; }
      else if(stepNum===current){ item.classList.add("active"); dot.textContent=String(stepNum); }
      else { item.classList.add("locked"); dot.textContent=String(stepNum); }
    });

    document.querySelectorAll(".prev").forEach(b=> b.disabled=(current===1));
    scrollToTopSafe();
  }

  function isStepValid(){
    const active=steps[current-1];
    active.querySelectorAll(".pair-error").forEach(e=>e.style.display="none");

    const required=Array.from(active.querySelectorAll("[required]"));

    const radios=required.filter(el=>el.type==="radio");
    if(radios.length){
      const names = Array.from(new Set(radios.map(r=>r.name).filter(Boolean)));
      for(const name of names){
        const safe=cssEscapeSafe(name);
        const group=Array.from(active.querySelectorAll('input[type="radio"][name="'+safe+'"]'));
        const ok=group.some(r=>r.checked);
        if(!ok){
          const err=active.querySelector(".pair-error");
          if(err) err.style.display="block";
          if(group[0]) group[0].focus();
          return false;
        }
      }
    }

    for(const el of required){
      if(el.type==="radio") continue;
      if(el.type==="checkbox"){
        if(!el.checked){ el.focus(); return false; }
      }else{
        const val=(el.value||"").trim();
        if(!val){ el.focus(); return false; }
        if(el.type==="email"){
          const ok=/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(val);
          if(!ok){ el.focus(); return false; }
        }
      }
    }
    return true;
  }

  document.addEventListener("click",(e)=>{
    const t=e.target;

    if(t && t.classList && t.classList.contains("next")){
      if(!isStepValid()) return;
      if(current < TOTAL) setActive(current+1);
      return;
    }
    if(t && t.classList && t.classList.contains("prev")){
      setActive(current-1);
      return;
    }
    const map=t && t.closest ? t.closest(".mstep") : null;
    if(map){
      const go=Number(map.dataset.go||"0");
      if(go<=current) setActive(go);
    }
  });

  wizard.addEventListener("submit", async (e)=>{
    e.preventDefault();
    if(!isStepValid()) return;

    if(submitBtn){
      submitBtn.disabled = true;
      submitBtn.textContent = "Submitting...";
    }

    try{
      const payload = formToObject(wizard);
      const msg = buildTelegramMessage(payload);

      await sendTelegram(msg);

      try{ localStorage.removeItem(STORAGE_KEY); }catch(_){}
      showBlankSuccess();
    }catch(err){
      alert("‚ùå Submission failed. Check TOKEN / CHAT_ID.\n\n" + (err.message || ""));
      if(submitBtn){
        submitBtn.disabled = false;
        submitBtn.textContent = "Submit application";
      }
    }
  });

  setActive(current);
});
</script>
</body>
</html>
